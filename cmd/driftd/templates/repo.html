{{define "title"}}{{.Name}}{{end}}

{{define "stack-node"}}
{{if .Children}}
<details class="stack-group" {{if .Open}}open{{end}}>
    <summary class="stack-row stack-group-row" style="--depth: {{.Depth}}">
        <div class="stack-cell stack-name">
            <span class="stack-caret" aria-hidden="true"></span>
            <span class="stack-label">{{.Name}}</span>
            <span class="stack-meta">{{.Total}} stacks</span>
        </div>
        <div class="stack-cell status">
            {{if .Error}}<span class="badge badge-error">{{.Error}} error</span>{{end}}
            {{if .Drifted}}<span class="badge badge-drift">{{.Drifted}} drift</span>{{end}}
            {{if .Ok}}<span class="badge badge-ok">{{.Ok}} ok</span>{{end}}
        </div>
        <div class="stack-cell changes">-</div>
        <div class="stack-cell run">-</div>
        <div class="stack-cell actions"></div>
    </summary>
    <div class="stack-group-children">
        {{range .Children}}
            {{template "stack-node" .}}
        {{end}}
    </div>
</details>
{{else}}
<div class="stack-row stack-leaf" style="--depth: {{.Depth}}">
    <div class="stack-cell stack-name">
        <span class="stack-leaf-dot" aria-hidden="true"></span>
        <a href="/repos/{{.RepoName}}/stacks/{{.Path}}" class="stack-link">{{.Name}}</a>
        <span class="stack-meta">{{.Path}}</span>
    </div>
    <div class="stack-cell status">
        {{if .Status.Error}}
        <span class="badge badge-error">Error</span>
        {{else if .Status.Drifted}}
        <span class="badge badge-drift">Drift</span>
        {{else}}
        <span class="badge badge-ok">OK</span>
        {{end}}
    </div>
    <div class="stack-cell changes">
        {{if or .Status.Added .Status.Changed .Status.Destroyed}}
        <span class="changes">
            {{if .Status.Added}}<span class="add">+{{.Status.Added}}</span>{{end}}
            {{if .Status.Changed}}<span class="change">~{{.Status.Changed}}</span>{{end}}
            {{if .Status.Destroyed}}<span class="destroy">-{{.Status.Destroyed}}</span>{{end}}
        </span>
        {{else}}
        -
        {{end}}
    </div>
    <div class="stack-cell run">{{timeAgo .Status.RunAt}}</div>
    <div class="stack-cell actions">
        <form method="POST" action="/repos/{{.RepoName}}/stacks/{{.Path}}" class="inline-form">
            <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
            <button type="submit" class="btn btn-small">Scan</button>
        </form>
    </div>
</div>
{{end}}
{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Repositories</a> / <span>{{.Name}}</span>
</nav>

<div class="repo-header-section">
    <h1>{{.Name}}</h1>
    {{if .Config}}
    <form method="POST" action="/repos/{{.Name}}/scan" class="scan-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <button type="submit" class="btn btn-scan">Scan All Stacks</button>
    </form>
    {{end}}
</div>

{{if .ActiveTask}}
<div class="task-summary active">
    <div>
        <strong>Running</strong>
        <span class="meta">Task {{printf "%.7s" .ActiveTask.ID}}</span>
        {{if .ActiveTask.CommitSHA}}<span class="meta">Commit {{printf "%.7s" .ActiveTask.CommitSHA}}</span>{{end}}
    </div>
    <div class="progress">
        <div class="progress-bar">
            {{$pct := 0}}
            {{if gt .ActiveTask.Total 0}}
                {{$pct = div (mul (add .ActiveTask.Completed .ActiveTask.Failed) 100) .ActiveTask.Total}}
            {{end}}
            <div class="progress-fill" style="width: {{$pct}}%"></div>
        </div>
        <span class="meta">{{add .ActiveTask.Completed .ActiveTask.Failed}} / {{.ActiveTask.Total}}</span>
    </div>
</div>
{{else if .LastTask}}
<div class="task-summary">
    <div>
        <strong>Last run</strong>
        <span class="meta">{{timeAgo .LastTask.EndedAt}}</span>
        {{if .LastTask.CommitSHA}}<span class="meta">Commit {{printf "%.7s" .LastTask.CommitSHA}}</span>{{end}}
    </div>
</div>
{{end}}


{{if .Stacks}}
<section class="stacks">
    <div class="stack-tree">
        <div class="stack-tree-header">
            <div class="stack-cell stack-name">Stack</div>
            <div class="stack-cell status">Status</div>
            <div class="stack-cell changes">Changes</div>
            <div class="stack-cell run">Last Run</div>
            <div class="stack-cell actions">Actions</div>
        </div>
        <div class="stack-tree-body">
            {{range .StackTree}}
                {{template "stack-node" .}}
            {{end}}
        </div>
    </div>
</section>
{{else if .Config}}
<p class="empty-state">No scans yet. Click "Scan All Stacks" to start.</p>
{{else}}
<p class="empty-state">Repository not found in configuration.</p>
{{end}}

{{end}}
