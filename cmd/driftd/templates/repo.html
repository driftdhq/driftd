{{define "title"}}{{.Name}}{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Repositories</a> / <span>{{.Name}}</span>
</nav>

<div class="repo-header-section">
    <h1>{{.Name}}</h1>
    {{if .Config}}
    <form method="POST" action="/repos/{{.Name}}/scan" class="scan-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <button type="submit" class="btn btn-scan" {{if .ActiveScan}}disabled{{end}}>Scan All Stacks</button>
    </form>
    {{end}}
</div>

{{if .ActiveScan}}
<div class="scan-summary active">
    <div>
        <strong>Scanning</strong>
        {{if .ActiveScan.CommitSHA}}<span class="meta">commit {{printf "%.7s" .ActiveScan.CommitSHA}}</span>{{end}}
    </div>
    <div class="progress">
        <div class="progress-bar">
            {{$pct := 0}}
            {{if gt .ActiveScan.Total 0}}
                {{$pct = div (mul (add .ActiveScan.Completed .ActiveScan.Failed) 100) .ActiveScan.Total}}
            {{end}}
            <div class="progress-fill" style="width: {{$pct}}%"></div>
        </div>
        <span class="meta">{{add .ActiveScan.Completed .ActiveScan.Failed}} / {{.ActiveScan.Total}}</span>
    </div>
</div>
{{else if .LastScan}}
<div class="scan-summary">
    <div>
        <strong>Last scan</strong>
        <span class="meta">{{timeAgo .LastScan.EndedAt}}</span>
        {{if and .Config .LastScan.CommitSHA}}
            {{$commitURL := commitURL .Config.URL .LastScan.CommitSHA}}
            {{if $commitURL}}
                <span class="meta">Commit <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" .LastScan.CommitSHA}}</a></span>
            {{else}}
                <span class="meta">Commit {{printf "%.7s" .LastScan.CommitSHA}}</span>
            {{end}}
        {{end}}
    </div>
</div>
{{end}}


{{if .Stacks}}
<section class="stacks">
    <div class="stack-tree">
        <div class="stack-tree-header">
            <div class="stack-cell stack-name">Stack</div>
            <div class="stack-cell status">Status</div>
            <div class="stack-cell run">Last Run</div>
            <div class="stack-cell actions"></div>
        </div>
        <div class="stack-tree-body">
            {{range .Stacks}}
            <div class="stack-row stack-file">
                <div class="stack-cell stack-name">
                    <a href="/repos/{{$.Name}}/stacks/{{.Path}}" class="stack-link">{{.Path}}</a>
                </div>
                <div class="stack-cell status">
                    {{if .Error}}<span class="badge badge-error">error</span>
                    {{else if .Drifted}}<span class="badge badge-drift">drifted</span>
                    {{else}}<span class="badge badge-ok">ok</span>{{end}}
                </div>
                <div class="stack-cell run">{{timeAgo .RunAt}}</div>
                <div class="stack-cell actions">
                    <form method="POST" action="/repos/{{$.Name}}/stacks/{{.Path}}" class="inline-form">
                        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                        <button type="submit" class="btn btn-small">Scan</button>
                    </form>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</section>
{{else if .Config}}
<p class="empty-state">No scans yet. Click "Scan All Stacks" to start.</p>
{{else}}
<p class="empty-state">Repository not found in configuration.</p>
{{end}}

{{if .ActiveScan}}
<script>
    setTimeout(function () {
        window.location.reload();
    }, 5000);
</script>
{{end}}

{{end}}
