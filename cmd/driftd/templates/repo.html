{{define "title"}}{{.Name}}{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Repositories</a> / <span>{{.Name}}</span>
</nav>

<div class="repo-header-section">
    <h1>{{.Name}}</h1>
    {{if .Config}}
    <form method="POST" action="/repos/{{.Name}}/scan" class="scan-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <button type="submit" class="btn btn-scan" {{if .ActiveScan}}disabled{{end}}>Scan All Stacks</button>
    </form>
    {{end}}
</div>

{{if .ActiveScan}}
<div class="scan-summary active">
    <div>
        <strong>Scanning</strong>
        {{if .ActiveScan.CommitSHA}}<span class="meta">commit {{printf "%.7s" .ActiveScan.CommitSHA}}</span>{{end}}
    </div>
    <div class="progress">
        <div class="progress-bar">
            {{$pct := 0}}
            {{if gt .ActiveScan.Total 0}}
                {{$pct = div (mul (add .ActiveScan.Completed .ActiveScan.Failed) 100) .ActiveScan.Total}}
            {{end}}
            <div class="progress-fill" style="width: {{$pct}}%"></div>
        </div>
        <span class="meta">{{add .ActiveScan.Completed .ActiveScan.Failed}} / {{.ActiveScan.Total}}</span>
    </div>
</div>
{{else if .LastScan}}
<div class="scan-summary">
    <div>
        <strong>Last scan</strong>
        <span class="meta">{{timeAgo .LastScan.EndedAt}}</span>
        {{if and .Config .LastScan.CommitSHA}}
            {{$commitURL := commitURL .Config.URL .LastScan.CommitSHA}}
            {{if $commitURL}}
                <span class="meta">Commit <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" .LastScan.CommitSHA}}</a></span>
            {{else}}
                <span class="meta">Commit {{printf "%.7s" .LastScan.CommitSHA}}</span>
            {{end}}
        {{end}}
    </div>
</div>
{{end}}


{{if .Stacks}}
<section class="stacks">
    <div class="stack-tree">
        <div class="stack-tree-header">
            <div class="stack-cell stack-name">Stack</div>
            <div class="stack-cell status">Status</div>
            <div class="stack-cell run">Last Run</div>
            <div class="stack-cell actions"></div>
        </div>
        <div class="stack-tree-body">
            {{range .Stacks}}
            <div class="stack-row stack-file" data-stack-path="{{.Path}}">
                <div class="stack-cell stack-name">
                    <a href="/repos/{{$.Name}}/stacks/{{.Path}}" class="stack-link">{{.Path}}</a>
                </div>
                <div class="stack-cell status">
                    {{if .Error}}<span class="badge badge-error">error</span>
                    {{else if .Drifted}}<span class="badge badge-drift">drifted</span>
                    {{else}}<span class="badge badge-ok">ok</span>{{end}}
                </div>
                <div class="stack-cell run">{{timeAgo .RunAt}}</div>
                <div class="stack-cell actions">
                    <form method="POST" action="/repos/{{$.Name}}/stacks/{{.Path}}" class="inline-form">
                        <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                        <button type="submit" class="btn btn-small">Scan</button>
                    </form>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</section>
{{else if .Config}}
<p class="empty-state">No scans yet. Click "Scan All Stacks" to start.</p>
{{else}}
<p class="empty-state">Repository not found in configuration.</p>
{{end}}

<script>
    (function () {
        if (!window.EventSource) return;
        const repoName = "{{.Name}}";
        const source = new EventSource(`/api/repos/${encodeURIComponent(repoName)}/events`);

        const formatStatus = (status, drifted, error) => {
            if (error) return '<span class="badge badge-error">error</span>';
            if (status === "running") return '<span class="badge badge-running">running</span>';
            if (drifted) return '<span class="badge badge-drift">drifted</span>';
            return '<span class="badge badge-ok">ok</span>';
        };

        const updateRow = (stack) => {
            if (!stack || !stack.path) return;
            const row = document.querySelector(`.stack-row[data-stack-path="${CSS.escape(stack.path)}"]`);
            if (!row) return;
            const statusCell = row.querySelector(".stack-cell.status");
            if (statusCell) {
                statusCell.innerHTML = formatStatus(stack.status, stack.drifted, stack.error);
            }
            const runCell = row.querySelector(".stack-cell.run");
            if (runCell) {
                if (stack.status === "running") {
                    runCell.textContent = "running...";
                } else if (stack.run_at) {
                    runCell.textContent = "just now";
                }
            }
        };

        const updateScanProgress = (scan) => {
            if (!scan) return;
            const summary = document.querySelector(".scan-summary.active");
            if (!summary) return;
            const progressFill = summary.querySelector(".progress-fill");
            const progressMeta = summary.querySelector(".progress .meta");
            if (!progressFill || !progressMeta) return;
            const done = (scan.completed || 0) + (scan.failed || 0);
            const total = scan.total || 0;
            const pct = total > 0 ? Math.floor((done * 100) / total) : 0;
            progressFill.style.width = `${pct}%`;
            progressMeta.textContent = `${done} / ${total}`;
        };

        source.addEventListener("snapshot", (e) => {
            const data = JSON.parse(e.data || "{}");
            if (Array.isArray(data.stacks)) {
                data.stacks.forEach((stack) => {
                    updateRow({
                        path: stack.path,
                        drifted: stack.drifted,
                        error: stack.error,
                        status: stack.error ? "failed" : (stack.drifted ? "completed" : "completed"),
                        run_at: stack.run_at,
                    });
                });
            }
            updateScanProgress(data.active_scan);
        });

        source.addEventListener("update", (e) => {
            const data = JSON.parse(e.data || "{}");
            if (data.type === "stack_update") {
                updateRow({
                    path: data.stack_path,
                    drifted: data.drifted,
                    error: data.error,
                    status: data.status,
                    run_at: data.run_at,
                });
            }
            if (data.type === "scan_update") {
                updateScanProgress({
                    completed: data.completed,
                    failed: data.failed,
                    total: data.total,
                });
            }
        });
    })();
</script>

{{end}}
