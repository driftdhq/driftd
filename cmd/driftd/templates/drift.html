{{define "title"}}{{.Path}}{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Projects</a> /
    <a href="/projects/{{.ProjectName}}">{{.ProjectName}}</a> /
    <span>{{.Path}}</span>
</nav>

<div class="stack-header" data-project="{{.ProjectName}}" data-stack="{{.Path}}">
    <div class="stack-title">
        <h1>{{.Path}}</h1>
        {{if .Result}}
            {{if .Result.Error}}
            <span class="badge badge-error">Error</span>
            {{else if .Result.Drifted}}
            <span class="badge badge-drift">Drifted</span>
            {{else}}
            <span class="badge badge-ok">Healthy</span>
            {{end}}
        {{end}}
    </div>
</div>

{{if .Result}}
{{if .Result.PlanOutput}}
<section class="plan-output" id="plan-output-section">
    <div class="plan-output-header">
        <div class="plan-output-title">
            <h2>Plan Output</h2>
            {{if .Scan}}
                <span class="meta">last scan {{timeAgo .Scan.EndedAt}}</span>
                {{if .Scan.CommitSHA}}
                    {{$commitURL := commitURL .ProjectURL .Scan.CommitSHA}}
                    {{if $commitURL}}
                        <span class="meta">commit <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" .Scan.CommitSHA}}</a></span>
                    {{else}}
                        <span class="meta">commit {{printf "%.7s" .Scan.CommitSHA}}</span>
                    {{end}}
                {{end}}
            {{end}}
        </div>
        <button type="button" class="btn btn-small btn-copy" data-copy-target="plan-output-raw">Copy</button>
    </div>
    <textarea id="plan-output-raw" class="sr-only">{{.Result.PlanOutput}}</textarea>
    <pre>{{.PlanHTML}}</pre>
</section>
{{end}}
{{else}}
<p class="empty-state">No scan results available. Click "Rescan" to run a drift check.</p>
{{end}}
{{end}}

<script>
    (function () {
        const header = document.querySelector(".stack-header");
        if (!header) return;
        const projectName = header.dataset.project;
        const stackPath = header.dataset.stack;
        const statusBadge = header.querySelector(".badge");
        const planSection = document.getElementById("plan-output-section");

        const stripAnsi = (text) => text.replace(/\u001b\[[0-9;]*[A-Za-z]/g, "");

        const initCopyButton = () => {
            const btn = document.querySelector(".btn-copy");
            const target = document.getElementById(btn?.dataset.copyTarget || "");
            if (!btn || !target) return;
            btn.onclick = async () => {
                try {
                    const raw = target.value || "";
                    await navigator.clipboard.writeText(stripAnsi(raw));
                    btn.textContent = "Copied";
                    setTimeout(() => {
                        btn.textContent = "Copy";
                    }, 1500);
                } catch (err) {
                    btn.textContent = "Copy failed";
                    setTimeout(() => {
                        btn.textContent = "Copy";
                    }, 1500);
                }
            };
        };

        const updateStatusBadge = (status, drifted, error) => {
            if (!statusBadge) return;
            if (error) {
                statusBadge.className = "badge badge-error";
                statusBadge.textContent = "Error";
                return;
            }
            if (status === "running") {
                statusBadge.className = "badge badge-running";
                statusBadge.textContent = "Running";
                return;
            }
            if (drifted) {
                statusBadge.className = "badge badge-drift";
                statusBadge.textContent = "Drifted";
            } else {
                statusBadge.className = "badge badge-ok";
                statusBadge.textContent = "Healthy";
            }
        };

        const refreshPlanOutput = async () => {
            if (!planSection) {
                window.location.reload();
                return;
            }
            const resp = await fetch(window.location.href, { headers: { "X-Requested-With": "fetch" } });
            if (!resp.ok) return;
            const html = await resp.text();
            const doc = new DOMParser().parseFromString(html, "text/html");
            const nextPlan = doc.getElementById("plan-output-section");
            if (!nextPlan) return;
            planSection.innerHTML = nextPlan.innerHTML;
            initCopyButton();
        };

        initCopyButton();

        if (window.EventSource) {
            const source = new EventSource(`/api/projects/${encodeURIComponent(projectName)}/events`);
            source.addEventListener("update", (e) => {
                const data = JSON.parse(e.data || "{}");
                const kind = data.kind || (data.type === "stack_update" ? "stack" : "");
                if (kind !== "stack" || data.stack_path !== stackPath) return;
                if (data.status === "running") {
                    updateStatusBadge("running");
                    return;
                }
                if (data.status === "completed") {
                    updateStatusBadge("completed", data.drifted);
                    refreshPlanOutput();
                    return;
                }
                if (data.status === "failed") {
                    updateStatusBadge("failed", false, true);
                    refreshPlanOutput();
                }
            });
        }
    })();
</script>
