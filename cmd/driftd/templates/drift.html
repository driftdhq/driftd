{{define "title"}}{{.Path}}{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Repositories</a> /
    <a href="/repos/{{.RepoName}}">{{.RepoName}}</a> /
    <span>{{.Path}}</span>
</nav>

<div class="stack-header">
    <div class="stack-title">
        <h1>{{.Path}}</h1>
        {{if .Result}}
            {{if .Result.Error}}
            <span class="badge badge-error">error</span>
            {{else if .Result.Drifted}}
            <span class="badge badge-drift">drifted</span>
            {{else}}
            <span class="badge badge-ok">healthy</span>
            {{end}}
        {{end}}
    </div>
    <form method="POST" action="/repos/{{.RepoName}}/stacks/{{.Path}}" class="scan-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <button type="submit" class="btn btn-scan">Rescan</button>
    </form>
</div>

{{if .Result}}
{{if .Result.PlanOutput}}
<section class="plan-output">
    <div class="plan-output-header">
        <div class="plan-output-title">
            <h2>Plan Output</h2>
            {{if .Scan}}
                <span class="meta">last scan {{timeAgo .Scan.EndedAt}}</span>
                {{if .Scan.CommitSHA}}
                    {{$commitURL := commitURL .RepoURL .Scan.CommitSHA}}
                    {{if $commitURL}}
                        <span class="meta">commit <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" .Scan.CommitSHA}}</a></span>
                    {{else}}
                        <span class="meta">commit {{printf "%.7s" .Scan.CommitSHA}}</span>
                    {{end}}
                {{end}}
            {{end}}
        </div>
        <button type="button" class="btn btn-small btn-copy" data-copy-target="plan-output-raw">Copy</button>
    </div>
    <textarea id="plan-output-raw" class="sr-only">{{.Result.PlanOutput}}</textarea>
    <pre>{{.PlanHTML}}</pre>
</section>
    <script>
        (function () {
            const btn = document.querySelector(".btn-copy");
            const target = document.getElementById(btn?.dataset.copyTarget || "");
            if (!btn || !target) return;
            const stripAnsi = (text) => text.replace(/\u001b\[[0-9;]*[A-Za-z]/g, "");
            btn.addEventListener("click", async () => {
                try {
                    const raw = target.value || "";
                    await navigator.clipboard.writeText(stripAnsi(raw));
                    btn.textContent = "Copied";
                    setTimeout(() => {
                        btn.textContent = "Copy";
                }, 1500);
            } catch (err) {
                btn.textContent = "Copy failed";
                setTimeout(() => {
                    btn.textContent = "Copy";
                }, 1500);
            }
        });
    })();
</script>
{{end}}
{{else}}
<p class="empty-state">No scan results available. Click "Rescan" to run a drift check.</p>
{{end}}
{{end}}
