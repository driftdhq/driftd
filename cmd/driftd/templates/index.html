{{define "title"}}Dashboard{{end}}

{{define "content"}}
<div class="page-header">
    <div>
        <h1>Repositories</h1>
        <p class="page-subtitle">Terraform drift status across all configured stacks.</p>
    </div>
</div>

<section class="overview">
    <div class="overview-card">
        <span class="overview-label">Repos</span>
        <span class="overview-value">{{.TotalRepos}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Stacks</span>
        <span class="overview-value">{{.TotalStacks}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Active Scans</span>
        <span class="overview-value">{{.ActiveScans}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Drifted Repos</span>
        <span class="overview-value">{{.DriftedRepos}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Locked Repos</span>
        <span class="overview-value">{{.LockedRepos}}</span>
    </div>
</section>

{{if .ConfigRepos}}
<section class="repos">
    {{range .ConfigRepos}}
    <a class="repo-card" href="/repos/{{.Name}}">
        <div class="repo-header">
            {{$repo := index $.RepoByName .Name}}
            <span class="status-indicator {{if $repo.Drifted}}drifted{{else}}ok{{end}}"></span>
            <span class="repo-name">{{.Name}}</span>
        </div>
        <div class="repo-meta">
            <span>{{$repo.Stacks}} stacks discovered</span>
            {{if $repo.Active}}
                <span class="meta-pill">Scanning {{$repo.Progress}}</span>
            {{else if not $repo.LastRun.IsZero}}
                <span class="meta-pill">Last scan {{timeAgo $repo.LastRun}}</span>
            {{end}}
            {{if $repo.CommitSHA}}
                {{$repoCfg := index $.ConfigByName .Name}}
                {{$commitURL := commitURL $repoCfg.URL $repo.CommitSHA}}
                {{if $commitURL}}
                    <span class="meta-pill">Commit <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" $repo.CommitSHA}}</a></span>
                {{else}}
                    <span class="meta-pill">Commit {{printf "%.7s" $repo.CommitSHA}}</span>
                {{end}}
            {{end}}
        </div>
    </a>
    {{end}}
</section>
{{else}}
<p class="empty-state">No repositories configured. Add repos to your config file.</p>
{{end}}
{{end}}
