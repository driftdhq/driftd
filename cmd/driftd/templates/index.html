{{define "title"}}Dashboard{{end}}

{{define "content"}}
<div class="page-header">
    <div>
        <h1>Projects</h1>
        <p class="page-subtitle">Terraform drift status across all configured projects.</p>
    </div>
</div>

<section class="overview">
    <div class="overview-card">
        <span class="overview-label">Stacks</span>
        <span class="overview-value">{{.TotalStacks}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Healthy</span>
        <span class="overview-value">{{.HealthyPct}}%</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Drifted</span>
        <span class="overview-value">{{.DriftedStacks}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Active Scans</span>
        <span class="overview-value">{{.ActiveScans}}</span>
    </div>
</section>

{{if .ConfigRepos}}
<section class="projects-list">
    <div class="projects-list-header">
        <div class="project-cell name">Project</div>
        <div class="project-cell status"><span class="sr-only">Last Scan</span></div>
        <div class="project-cell healthy">Healthy</div>
        <div class="project-cell drifted">Drifted</div>
        <div class="project-cell commit">Commit</div>
    </div>
    {{range .ConfigRepos}}
    {{$project := index $.ProjectByName .Name}}
    <div class="project-row project-row-link" data-project-name="{{.Name}}" data-href="/projects/{{.Name}}" role="link" tabindex="0" aria-label="View {{.Name}}">
        <div class="project-cell name">
            <span class="status-indicator {{if $project.Drifted}}drifted{{else}}healthy{{end}}"></span>
            <span class="project-name">{{.Name}}</span>
        </div>
        <div class="project-cell status">
            {{if $project.Active}}
                <span class="meta-pill project-scan-pill" data-last-scan="{{if not $project.LastRun.IsZero}}Last scan {{timeAgo $project.LastRun}}{{end}}">Scanning {{$project.Progress}}</span>
            {{else if not $project.LastRun.IsZero}}
                <span class="meta-pill project-scan-pill" data-last-scan="Last scan {{timeAgo $project.LastRun}}">Last scan {{timeAgo $project.LastRun}}</span>
            {{else}}
                <span class="meta-pill project-scan-pill">No scans yet</span>
            {{end}}
        </div>
        <div class="project-cell healthy"><span class="healthy-count">{{$project.HealthyStacks}}</span></div>
        <div class="project-cell drifted"><span class="drifted-count">{{$project.DriftedStacks}}</span></div>
        <div class="project-cell commit">
            {{if $project.CommitSHA}}
                {{$projectCfg := index $.ConfigByName .Name}}
                {{$commitURL := commitURL $projectCfg.URL $project.CommitSHA}}
                {{if $commitURL}}
                    <span class="meta-pill"> <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" $project.CommitSHA}}</a></span>
                {{else}}
                    <span class="meta-pill">{{printf "%.7s" $project.CommitSHA}}</span>
                {{end}}
            {{else}}
                -
            {{end}}
        </div>
    </div>
    {{end}}
</section>
{{else}}
<p class="empty-state">No projects configured. Add projects to your config file.</p>
{{end}}

<script>
    (function () {
        if (!window.EventSource) return;
        const source = new EventSource("/api/events");

        document.querySelectorAll(".project-row-link").forEach((row) => {
            row.addEventListener("click", (event) => {
                if (event.target.closest("a, button")) return;
                const href = row.getAttribute("data-href");
                if (href) window.location.assign(href);
            });
            row.addEventListener("keydown", (event) => {
                if (event.key !== "Enter" && event.key !== " ") return;
                event.preventDefault();
                const href = row.getAttribute("data-href");
                if (href) window.location.assign(href);
            });
        });

        const getProjectRow = (projectName) =>
            document.querySelector(`.project-row[data-project-name="${CSS.escape(projectName)}"]`);

        const getScanPill = (row) => row.querySelector(".project-scan-pill");

        source.addEventListener("update", (e) => {
            const data = JSON.parse(e.data || "{}");
            if (!data || !data.project) return;
            const row = getProjectRow(data.project);
            if (!row) {
                window.location.reload();
                return;
            }
            const kind = data.kind || (data.type === "scan_update" ? "scan" : "");
            if (kind === "scan") {
                if (data.status === "running") {
                    const pill = getScanPill(row);
                    if (pill) {
                        const done = (data.completed || 0) + (data.failed || 0);
                        const total = data.total || 0;
                        pill.textContent = `Scanning ${done} / ${total}`;
                    }
                } else if (data.status) {
                    const pill = getScanPill(row);
                    if (pill) {
                        const lastScan = pill.getAttribute("data-last-scan");
                        if (lastScan) {
                            pill.textContent = lastScan;
                        } else {
                            pill.remove();
                        }
                    }
                }
            }
        });
    })();
</script>
{{end}}
