{{define "title"}}Dashboard{{end}}

{{define "content"}}
<div class="page-header">
    <div>
        <h1>Repositories</h1>
        <p class="page-subtitle">Terraform drift status across all configured repositories.</p>
    </div>
</div>

<section class="overview">
    <div class="overview-card">
        <span class="overview-label">Stacks</span>
        <span class="overview-value">{{.TotalStacks}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Healthy</span>
        <span class="overview-value">{{.HealthyPct}}%</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Drifted</span>
        <span class="overview-value">{{.DriftedStacks}}</span>
    </div>
    <div class="overview-card">
        <span class="overview-label">Active Scans</span>
        <span class="overview-value">{{.ActiveScans}}</span>
    </div>
</section>

{{if .ConfigRepos}}
<section class="repos">
    {{range .ConfigRepos}}
    {{$repo := index $.RepoByName .Name}}
    <div class="repo-card" data-repo-name="{{.Name}}">
        <a class="repo-card-link" href="/repos/{{.Name}}" aria-label="View {{.Name}}"></a>
        <div class="repo-header">
            <span class="status-indicator {{if $repo.Drifted}}drifted{{else}}healthy{{end}}"></span>
            <span class="repo-name">{{.Name}}</span>
        </div>
        <div class="repo-meta">
            {{if $repo.HealthyStacks}}<span class="healthy-count">{{$repo.HealthyStacks}} healthy stacks</span>{{end}}
            {{if $repo.DriftedStacks}}<span class="drifted-count">{{$repo.DriftedStacks}} drifted stacks</span>{{end}}
            {{if $repo.Active}}
                <span class="meta-pill">Scanning {{$repo.Progress}}</span>
            {{else if not $repo.LastRun.IsZero}}
                <span class="meta-pill">Last scan {{timeAgo $repo.LastRun}}</span>
            {{end}}
            {{if $repo.CommitSHA}}
                {{$repoCfg := index $.ConfigByName .Name}}
                {{$commitURL := commitURL $repoCfg.URL $repo.CommitSHA}}
                {{if $commitURL}}
                    <span class="meta-pill">Commit <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" $repo.CommitSHA}}</a></span>
                {{else}}
                    <span class="meta-pill">Commit {{printf "%.7s" $repo.CommitSHA}}</span>
                {{end}}
            {{end}}
        </div>
    </div>
    {{end}}
</section>
{{else}}
<p class="empty-state">No repositories configured. Add repos to your config file.</p>
{{end}}

<script>
    (function () {
        if (!window.EventSource) return;
        const source = new EventSource("/api/events");

        const getRepoCard = (repoName) =>
            document.querySelector(`.repo-card[data-repo-name="${CSS.escape(repoName)}"]`);

        const ensureScanMeta = (card) => {
            const meta = card.querySelector(".repo-meta");
            if (!meta) return null;
            let pill = meta.querySelector(".meta-pill.scan-pill");
            if (!pill) {
                pill = document.createElement("span");
                pill.className = "meta-pill scan-pill";
                meta.appendChild(pill);
            }
            return pill;
        };

        const removeScanMeta = (card) => {
            const pill = card.querySelector(".meta-pill.scan-pill");
            if (pill) {
                pill.remove();
            }
        };

        source.addEventListener("update", (e) => {
            const data = JSON.parse(e.data || "{}");
            if (!data || !data.repo) return;
            const card = getRepoCard(data.repo);
            if (!card) {
                window.location.reload();
                return;
            }
            const kind = data.kind || (data.type === "scan_update" ? "scan" : "");
            if (kind === "scan") {
                if (data.status === "running") {
                    const pill = ensureScanMeta(card);
                    if (pill) {
                        const done = (data.completed || 0) + (data.failed || 0);
                        const total = data.total || 0;
                        pill.textContent = `Scanning ${done} / ${total}`;
                    }
                } else if (data.status) {
                    removeScanMeta(card);
                }
            }
        });
    })();
</script>
{{end}}
