{{define "title"}}Settings{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Repositories</a> / <span>Settings</span>
</nav>

<div class="page-header">
    <h1>Settings</h1>
</div>

<div class="settings-tabs">
    <button class="tab active" data-tab="integrations">Integrations</button>
    <button class="tab" data-tab="repos">Repositories</button>
</div>

<section id="integrations-tab" class="settings-section">
    <div class="section-header">
        <h2>Integrations</h2>
        {{if .DynamicIntegrationsEnabled}}
        <button class="btn btn-scan" onclick="showAddIntegrationModal()">Add Integration</button>
        {{end}}
    </div>

    <div id="integrations-list" class="repos-settings-list">
        <p class="loading">Loading integrations...</p>
    </div>
</section>

<section id="repos-tab" class="settings-section" style="display: none;">
    <div class="section-header">
        <h2>Repositories</h2>
        {{if .DynamicReposEnabled}}
        <button class="btn btn-scan" onclick="showAddRepoModal()">Add Repository</button>
        {{end}}
    </div>

    <div id="repos-list" class="repos-settings-list">
        <p class="loading">Loading repositories...</p>
    </div>
</section>

<!-- Add/Edit Integration Modal -->
<div id="integration-modal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeIntegrationModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="integration-modal-title">Add Integration</h3>
            <button class="modal-close" onclick="closeIntegrationModal()">&times;</button>
        </div>
        <form id="integration-form" onsubmit="saveIntegration(event)">
            <input type="hidden" id="integration-id" value="">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <div class="form-group">
                <label for="integration-name">Name</label>
                <input type="text" id="integration-name" name="name" required
                       placeholder="production-github">
            </div>

            <div class="form-group">
                <label for="integration-type">Type</label>
                <select id="integration-type" name="type" onchange="toggleIntegrationFields()" required>
                    <option value="">Select integration type</option>
                    <option value="github_app">GitHub App</option>
                    <option value="ssh">SSH Key</option>
                    <option value="https">HTTPS Token</option>
                </select>
            </div>

            <div id="integration-github-app-fields" class="auth-fields" style="display: none;">
                <div class="form-group">
                    <label for="integration-github-app-id">App ID</label>
                    <input type="number" id="integration-github-app-id" name="github_app_id">
                </div>
                <div class="form-group">
                    <label for="integration-github-installation-id">Installation ID</label>
                    <input type="number" id="integration-github-installation-id" name="github_installation_id">
                </div>
                <div class="form-group">
                    <label for="integration-github-private-key-path">Private Key Path</label>
                    <input type="text" id="integration-github-private-key-path" name="github_private_key_path"
                           placeholder="/etc/driftd/github-app.pem">
                    <small>Path must be mounted into the container</small>
                </div>
                <div class="form-group">
                    <label for="integration-github-private-key-env">Private Key Env (optional)</label>
                    <input type="text" id="integration-github-private-key-env" name="github_private_key_env"
                           placeholder="DRIFTD_GITHUB_APP_PRIVATE_KEY">
                </div>
                <div class="form-group">
                    <label for="integration-github-api-base-url">API Base URL (optional)</label>
                    <input type="text" id="integration-github-api-base-url" name="github_api_base_url"
                           placeholder="https://api.github.com">
                </div>
            </div>

            <div id="integration-ssh-fields" class="auth-fields" style="display: none;">
                <div class="form-group">
                    <label for="integration-ssh-key-path">SSH Key Path</label>
                    <input type="text" id="integration-ssh-key-path" name="ssh_key_path"
                           placeholder="/etc/driftd/id_rsa">
                </div>
                <div class="form-group">
                    <label for="integration-ssh-key-env">SSH Key Env (optional)</label>
                    <input type="text" id="integration-ssh-key-env" name="ssh_key_env"
                           placeholder="DRIFTD_SSH_KEY_PATH">
                </div>
                <div class="form-group">
                    <label for="integration-ssh-key-passphrase-env">Key Passphrase Env (optional)</label>
                    <input type="text" id="integration-ssh-key-passphrase-env" name="ssh_key_passphrase_env"
                           placeholder="DRIFTD_SSH_KEY_PASSPHRASE">
                </div>
                <div class="form-group">
                    <label for="integration-ssh-known-hosts-path">Known Hosts Path</label>
                    <input type="text" id="integration-ssh-known-hosts-path" name="ssh_known_hosts_path"
                           placeholder="/etc/driftd/known_hosts">
                </div>
                <div class="form-group">
                    <label class="checkbox">
                        <input type="checkbox" id="integration-ssh-insecure" name="ssh_insecure_ignore_host_key">
                        Disable host key verification (insecure)
                    </label>
                </div>
            </div>

            <div id="integration-https-fields" class="auth-fields" style="display: none;">
                <div class="form-group">
                    <label for="integration-https-token-env">Token Env</label>
                    <input type="text" id="integration-https-token-env" name="https_token_env"
                           placeholder="DRIFTD_GIT_TOKEN">
                </div>
                <div class="form-group">
                    <label for="integration-https-username">Username (optional)</label>
                    <input type="text" id="integration-https-username" name="https_username"
                           placeholder="x-access-token">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeIntegrationModal()">Cancel</button>
                <button type="submit" class="btn btn-scan">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Repository Modal -->
<div id="repo-modal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">Add Repository</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="repo-form" onsubmit="saveRepo(event)">
            <input type="hidden" id="repo-original-name" value="">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <div class="form-group">
                <label for="repo-name">Name</label>
                <input type="text" id="repo-name" name="name" required
                       pattern="[a-zA-Z0-9_-]+"
                       title="Alphanumeric, hyphens, and underscores only"
                       placeholder="my-infra-repo">
            </div>

            <div class="form-group">
                <label for="repo-url">Git URL</label>
                <input type="text" id="repo-url" name="url" required
                       placeholder="https://github.com/org/repo.git">
            </div>

            <div class="form-group">
                <label for="repo-branch">Branch (optional)</label>
                <input type="text" id="repo-branch" name="branch" placeholder="main">
            </div>

            <div class="form-group">
                <label for="repo-integration">Integration</label>
                <select id="repo-integration" name="integration_id" required></select>
            </div>

            <div class="form-group">
                <label for="repo-schedule">Schedule (optional)</label>
                <input type="text" id="repo-schedule" name="schedule"
                       placeholder="0 */6 * * * (cron expression)">
            </div>

            <div class="form-group">
                <label for="repo-ignore-paths">Ignore Paths (optional)</label>
                <input type="text" id="repo-ignore-paths" name="ignore_paths"
                       placeholder="**/modules/**, envs/dev/*">
                <small>Comma-separated glob patterns</small>
            </div>

            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-scan">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="modal" style="display: none;">
    <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h3>Delete Repository</h3>
            <button class="modal-close" onclick="closeDeleteModal()">&times;</button>
        </div>
        <p>Are you sure you want to delete <strong id="delete-repo-name"></strong>?</p>
        <p class="text-muted">This will remove the repository configuration. Scan history will be preserved.</p>
        <div class="modal-actions">
            <button type="button" class="btn" onclick="closeDeleteModal()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<script>
const csrfToken = "{{.CSRFToken}}";
const dynamicEnabled = {{.DynamicReposEnabled}};
const dynamicIntegrationsEnabled = {{.DynamicIntegrationsEnabled}};
let integrationsCache = [];
let deleteRepoName = "";
let deleteIntegrationID = "";

function setActiveTab(tabName) {
    document.querySelectorAll(".tab").forEach((tab) => {
        tab.classList.toggle("active", tab.dataset.tab === tabName);
    });
    document.querySelectorAll(".settings-section").forEach((section) => {
        section.style.display = section.id === `${tabName}-tab` ? "block" : "none";
    });
}

document.querySelectorAll(".tab").forEach((tab) => {
    tab.addEventListener("click", () => setActiveTab(tab.dataset.tab));
});

async function loadRepos() {
    try {
        const resp = await fetch("/api/settings/repos", {credentials: "same-origin"});
        const repos = await resp.json();
        renderRepos(repos);
    } catch (err) {
        document.getElementById("repos-list").innerHTML =
            '<p class="error">Failed to load repositories</p>';
    }
}

async function loadIntegrations() {
    if (!dynamicIntegrationsEnabled) {
        document.getElementById("integrations-list").innerHTML =
            '<p class="text-muted">Integration management is disabled.</p>';
        return;
    }
    try {
        const resp = await fetch("/api/settings/integrations", {credentials: "same-origin"});
        const integrations = await resp.json();
        integrationsCache = integrations || [];
        renderIntegrations(integrationsCache);
        populateIntegrationSelect();
    } catch (err) {
        document.getElementById("integrations-list").innerHTML =
            '<p class="error">Failed to load integrations</p>';
    }
}

function renderRepos(repos) {
    const container = document.getElementById("repos-list");
    if (repos.length === 0) {
        container.innerHTML = '<p class="empty-state">No repositories configured.</p>';
        return;
    }

    let html = '<div class="settings-table">';
    html += '<div class="settings-table-header">';
    html += '<div class="col-name">Name</div>';
    html += '<div class="col-url">URL</div>';
    html += '<div class="col-auth">Integration</div>';
    html += '<div class="col-source">Source</div>';
    html += '<div class="col-actions"></div>';
    html += '</div>';

    for (const repo of repos) {
        const isStatic = repo.source === "config";
        const integrationLabel = repo.integration_name || formatTypeLabel(repo.integration_type || repo.auth_type) || "none";
        const integrationType = repo.integration_type || repo.auth_type || "none";
        const sourceLabel = formatSourceLabel(repo.source);
        html += '<div class="settings-table-row">';
        html += `<div class="col-name">${escapeHtml(repo.name)}</div>`;
        html += `<div class="col-url"><span class="url-truncate">${escapeHtml(repo.url)}</span></div>`;
        html += `<div class="col-auth"><span class="badge badge-${integrationType}">${escapeHtml(integrationLabel)}</span></div>`;
        html += `<div class="col-source"><span class="source-badge source-${repo.source}">${escapeHtml(sourceLabel)}</span></div>`;
        html += '<div class="col-actions">';
        if (!isStatic && dynamicEnabled) {
            html += `<button class="btn btn-small" onclick="editRepo('${escapeHtml(repo.name)}')">Edit</button>`;
            html += `<button class="btn btn-small btn-danger-outline" onclick="deleteRepo('${escapeHtml(repo.name)}')">Delete</button>`;
        } else {
            html += '<span class="text-muted">Read-only</span>';
        }
        html += '</div>';
        html += '</div>';
    }
    html += '</div>';
    container.innerHTML = html;
}

function renderIntegrations(integrations) {
    const container = document.getElementById("integrations-list");
    if (!integrations || integrations.length === 0) {
        container.innerHTML = '<p class="empty-state">No integrations configured.</p>';
        return;
    }

    let html = '<div class="settings-table integrations-table">';
    html += '<div class="settings-table-header">';
    html += '<div class="col-name">Name</div>';
    html += '<div class="col-type">Type</div>';
    html += '<div class="col-details">Details</div>';
    html += '<div class="col-source">Source</div>';
    html += '<div class="col-actions"></div>';
    html += '</div>';

    for (const integration of integrations) {
        const details = integrationDetails(integration);
        const sourceLabel = formatSourceLabel(integration.source);
        html += '<div class="settings-table-row">';
        html += `<div class="col-name">${escapeHtml(integration.name)}</div>`;
        html += `<div class="col-type"><span class="badge badge-${integration.type || 'none'}">${escapeHtml(formatTypeLabel(integration.type) || "none")}</span></div>`;
        html += `<div class="col-details"><div class="integration-details">${details}</div></div>`;
        html += `<div class="col-source"><span class="source-badge source-${integration.source}">${escapeHtml(sourceLabel)}</span></div>`;
        html += '<div class="col-actions">';
        if (dynamicIntegrationsEnabled) {
            html += `<button class="btn btn-small" onclick="editIntegration('${escapeHtml(integration.id)}')">Edit</button>`;
            html += `<button class="btn btn-small btn-danger-outline" onclick="deleteIntegration('${escapeHtml(integration.id)}', '${escapeHtml(integration.name)}')">Delete</button>`;
        } else {
            html += '<span class="text-muted">Read-only</span>';
        }
        html += '</div>';
        html += '</div>';
    }
    html += '</div>';
    container.innerHTML = html;
}

function integrationDetails(integration) {
    if (integration.type === "github_app") {
        const app = integration.github_app_id ? `App ${integration.github_app_id}` : "App -";
        const install = integration.github_installation_id ? `Install ${integration.github_installation_id}` : "Install -";
        return `<span>${escapeHtml(app)}</span><span>${escapeHtml(install)}</span>`;
    }
    if (integration.type === "ssh") {
        const value = integration.ssh_key_path || integration.ssh_key_env || "SSH";
        return `<span>${escapeHtml(value)}</span>`;
    }
    if (integration.type === "https") {
        const value = integration.https_token_env || "HTTPS";
        return `<span>${escapeHtml(value)}</span>`;
    }
    return "";
}

function populateIntegrationSelect(selectedId) {
    const select = document.getElementById("repo-integration");
    if (!select) return;
    select.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = integrationsCache.length ? "Select integration" : "No integrations available";
    select.appendChild(placeholder);

    if (!integrationsCache.length) {
        select.disabled = true;
        return;
    }

    select.disabled = false;
    integrationsCache.forEach((integration) => {
        const option = document.createElement("option");
        option.value = integration.id;
        option.textContent = `${integration.name} (${integration.type})`;
        select.appendChild(option);
    });

    if (selectedId) {
        select.value = selectedId;
    } else if (integrationsCache.length === 1) {
        select.value = integrationsCache[0].id;
    }
}

function showAddRepoModal() {
    document.getElementById("modal-title").textContent = "Add Repository";
    document.getElementById("repo-form").reset();
    document.getElementById("repo-original-name").value = "";
    document.getElementById("repo-name").disabled = false;
    populateIntegrationSelect();
    document.getElementById("repo-modal").style.display = "flex";
}

function showAddIntegrationModal() {
    document.getElementById("integration-modal-title").textContent = "Add Integration";
    document.getElementById("integration-form").reset();
    document.getElementById("integration-id").value = "";
    hideAllIntegrationFields();
    document.getElementById("integration-modal").style.display = "flex";
}

async function editRepo(name) {
    try {
        const resp = await fetch(`/api/settings/repos/${encodeURIComponent(name)}`, {credentials: "same-origin"});
        const repo = await resp.json();

        document.getElementById("modal-title").textContent = "Edit Repository";
        document.getElementById("repo-original-name").value = repo.name;
        document.getElementById("repo-name").value = repo.name;
        document.getElementById("repo-name").disabled = true;
        document.getElementById("repo-url").value = repo.url;
        document.getElementById("repo-branch").value = repo.branch || "";
        document.getElementById("repo-schedule").value = repo.schedule || "";
        document.getElementById("repo-ignore-paths").value = (repo.ignore_paths || []).join(", ");

        populateIntegrationSelect(repo.integration_id || "");

        document.getElementById("repo-modal").style.display = "flex";
    } catch (err) {
        alert("Failed to load repository details");
    }
}

async function editIntegration(id) {
    try {
        const resp = await fetch(`/api/settings/integrations/${encodeURIComponent(id)}`, {credentials: "same-origin"});
        const integration = await resp.json();

        document.getElementById("integration-modal-title").textContent = "Edit Integration";
        document.getElementById("integration-id").value = integration.id;
        document.getElementById("integration-name").value = integration.name || "";
        document.getElementById("integration-type").value = integration.type || "";

        if (integration.type === "github_app") {
            document.getElementById("integration-github-app-id").value = integration.github_app_id || "";
            document.getElementById("integration-github-installation-id").value = integration.github_installation_id || "";
            document.getElementById("integration-github-private-key-path").value = integration.github_private_key_path || "";
            document.getElementById("integration-github-private-key-env").value = integration.github_private_key_env || "";
            document.getElementById("integration-github-api-base-url").value = integration.github_api_base_url || "";
        } else if (integration.type === "ssh") {
            document.getElementById("integration-ssh-key-path").value = integration.ssh_key_path || "";
            document.getElementById("integration-ssh-key-env").value = integration.ssh_key_env || "";
            document.getElementById("integration-ssh-key-passphrase-env").value = integration.ssh_key_passphrase_env || "";
            document.getElementById("integration-ssh-known-hosts-path").value = integration.ssh_known_hosts_path || "";
            document.getElementById("integration-ssh-insecure").checked = !!integration.ssh_insecure_ignore_host_key;
        } else if (integration.type === "https") {
            document.getElementById("integration-https-token-env").value = integration.https_token_env || "";
            document.getElementById("integration-https-username").value = integration.https_username || "";
        }

        toggleIntegrationFields();
        document.getElementById("integration-modal").style.display = "flex";
    } catch (err) {
        alert("Failed to load integration details");
    }
}

function closeModal() {
    document.getElementById("repo-modal").style.display = "none";
}

function closeIntegrationModal() {
    document.getElementById("integration-modal").style.display = "none";
}

async function saveRepo(e) {
    e.preventDefault();
    const originalName = document.getElementById("repo-original-name").value;
    const isEdit = originalName !== "";

    const ignorePaths = document.getElementById("repo-ignore-paths").value
        .split(",")
        .map(p => p.trim())
        .filter(p => p);

    const data = {
        name: document.getElementById("repo-name").value,
        url: document.getElementById("repo-url").value,
        branch: document.getElementById("repo-branch").value,
        integration_id: document.getElementById("repo-integration").value,
        schedule: document.getElementById("repo-schedule").value,
        ignore_paths: ignorePaths,
    };

    try {
        const url = isEdit
            ? `/api/settings/repos/${encodeURIComponent(originalName)}`
            : "/api/settings/repos";
        const method = isEdit ? "PUT" : "POST";

        const resp = await fetch(url, {
            method: method,
            headers: {"Content-Type": "application/json"},
            credentials: "same-origin",
            body: JSON.stringify(data),
        });

        if (!resp.ok) {
            const err = await resp.json();
            alert(err.error || "Failed to save repository");
            return;
        }

        closeModal();
        loadRepos();
    } catch (err) {
        alert("Failed to save repository");
    }
}

async function saveIntegration(e) {
    e.preventDefault();
    const integrationID = document.getElementById("integration-id").value;
    const isEdit = integrationID !== "";

    const data = {
        name: document.getElementById("integration-name").value,
        type: document.getElementById("integration-type").value,
        github_app_id: parseInt(document.getElementById("integration-github-app-id").value) || 0,
        github_installation_id: parseInt(document.getElementById("integration-github-installation-id").value) || 0,
        github_private_key_path: document.getElementById("integration-github-private-key-path").value,
        github_private_key_env: document.getElementById("integration-github-private-key-env").value,
        github_api_base_url: document.getElementById("integration-github-api-base-url").value,
        ssh_key_path: document.getElementById("integration-ssh-key-path").value,
        ssh_key_env: document.getElementById("integration-ssh-key-env").value,
        ssh_key_passphrase_env: document.getElementById("integration-ssh-key-passphrase-env").value,
        ssh_known_hosts_path: document.getElementById("integration-ssh-known-hosts-path").value,
        ssh_insecure_ignore_host_key: document.getElementById("integration-ssh-insecure").checked,
        https_token_env: document.getElementById("integration-https-token-env").value,
        https_username: document.getElementById("integration-https-username").value,
    };

    try {
        const url = isEdit
            ? `/api/settings/integrations/${encodeURIComponent(integrationID)}`
            : "/api/settings/integrations";
        const method = isEdit ? "PUT" : "POST";
        const resp = await fetch(url, {
            method: method,
            headers: {"Content-Type": "application/json"},
            credentials: "same-origin",
            body: JSON.stringify(data),
        });

        if (!resp.ok) {
            const err = await resp.json();
            alert(err.error || "Failed to save integration");
            return;
        }

        closeIntegrationModal();
        loadIntegrations();
    } catch (err) {
        alert("Failed to save integration");
    }
}

function deleteRepo(name) {
    deleteRepoName = name;
    document.getElementById("delete-repo-name").textContent = name;
    document.getElementById("delete-modal").style.display = "flex";
}

function deleteIntegration(id, name) {
    deleteIntegrationID = id;
    document.getElementById("delete-repo-name").textContent = name;
    document.querySelector("#delete-modal h3").textContent = "Delete Integration";
    document.querySelector("#delete-modal .text-muted").textContent =
        "This will remove the integration configuration.";
    document.getElementById("delete-modal").style.display = "flex";
}

function closeDeleteModal() {
    document.getElementById("delete-modal").style.display = "none";
    deleteRepoName = "";
    deleteIntegrationID = "";
    document.querySelector("#delete-modal h3").textContent = "Delete Repository";
    document.querySelector("#delete-modal .text-muted").textContent =
        "This will remove the repository configuration. Scan history will be preserved.";
}

async function confirmDelete() {
    if (!deleteRepoName && !deleteIntegrationID) return;

    try {
        const target = deleteIntegrationID
            ? `/api/settings/integrations/${encodeURIComponent(deleteIntegrationID)}`
            : `/api/settings/repos/${encodeURIComponent(deleteRepoName)}`;
        const resp = await fetch(target, {
            method: "DELETE",
            credentials: "same-origin",
        });

        if (!resp.ok) {
            const err = await resp.json();
            alert(err.error || "Failed to delete");
            return;
        }

        closeDeleteModal();
        loadIntegrations();
        loadRepos();
    } catch (err) {
        alert("Failed to delete");
    }
}

function toggleIntegrationFields() {
    hideAllIntegrationFields();
    const type = document.getElementById("integration-type").value;
    if (type === "github_app") {
        document.getElementById("integration-github-app-fields").style.display = "block";
    } else if (type === "ssh") {
        document.getElementById("integration-ssh-fields").style.display = "block";
    } else if (type === "https") {
        document.getElementById("integration-https-fields").style.display = "block";
    }
}

function hideAllIntegrationFields() {
    document.getElementById("integration-github-app-fields").style.display = "none";
    document.getElementById("integration-ssh-fields").style.display = "none";
    document.getElementById("integration-https-fields").style.display = "none";
}

function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
}

function formatTypeLabel(type) {
    if (!type) return "";
    if (type === "github_app") return "GitHub App";
    if (type === "ssh") return "SSH";
    if (type === "https") return "HTTPS";
    return type;
}

function formatSourceLabel(source) {
    if (source === "config") return "config file";
    if (source === "dynamic") return "manual config";
    return source || "";
}

// Load data on page load
loadIntegrations();
loadRepos();
</script>
{{end}}
