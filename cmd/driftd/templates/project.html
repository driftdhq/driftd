{{define "title"}}{{.Name}}{{end}}

{{define "content"}}
<nav class="breadcrumb">
    <a href="/">Projects</a> / <span>{{.Name}}</span>
</nav>

<div class="project-header-section">
    <div class="project-title-group">
        <h1>{{.Name}}</h1>
        {{if and .Config .ActiveScan .ActiveScan.CommitSHA}}
            {{$commitURL := commitURL .Config.URL .ActiveScan.CommitSHA}}
            <span class="meta-pill project-commit-pill">
                Commit
                {{if $commitURL}}
                    <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" .ActiveScan.CommitSHA}}</a>
                {{else}}
                    {{printf "%.7s" .ActiveScan.CommitSHA}}
                {{end}}
            </span>
        {{else if and .Config .LastScan .LastScan.CommitSHA}}
            {{$commitURL := commitURL .Config.URL .LastScan.CommitSHA}}
            <span class="meta-pill project-commit-pill">
                Commit
                {{if $commitURL}}
                    <a href="{{$commitURL}}" target="_blank" rel="noreferrer">{{printf "%.7s" .LastScan.CommitSHA}}</a>
                {{else}}
                    {{printf "%.7s" .LastScan.CommitSHA}}
                {{end}}
            </span>
        {{end}}
    </div>
    {{if .Config}}
    <form method="POST" action="/projects/{{.Name}}/scan" class="scan-form">
        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
        <button type="submit" class="btn btn-scan" {{if .ActiveScan}}disabled{{end}}>Scan All Stacks</button>
    </form>
    {{end}}
</div>

{{if .Stacks}}
<section class="stacks">
    <div class="stack-toolbar">
        <div class="stack-progress-anchor{{if .ActiveScan}} is-active{{end}}">
            {{if .ActiveScan}}
            <div class="progress">
                <div class="progress-bar">
                    {{$pct := 0}}
                    {{if gt .ActiveScan.Total 0}}
                        {{$pct = div (mul (add .ActiveScan.Completed .ActiveScan.Failed) 100) .ActiveScan.Total}}
                    {{end}}
                    <div class="progress-fill" style="width: {{$pct}}%"></div>
                </div>
                <span class="meta">{{add .ActiveScan.Completed .ActiveScan.Failed}} / {{.ActiveScan.Total}}</span>
            </div>
            {{end}}
        </div>
        <form method="GET" action="/projects/{{.Name}}" class="stack-controls">
            <label class="stack-control">
                Sort
                <select name="sort">
                    <option value="path" {{if eq .Sort "path"}}selected{{end}}>Path</option>
                    <option value="status" {{if eq .Sort "status"}}selected{{end}}>Status</option>
                    <option value="last_run" {{if eq .Sort "last_run"}}selected{{end}}>Last Scan</option>
                </select>
            </label>
            <label class="stack-control">
                Order
                <select name="order">
                    <option value="asc" {{if eq .Order "asc"}}selected{{end}}>Asc</option>
                    <option value="desc" {{if eq .Order "desc"}}selected{{end}}>Desc</option>
                </select>
            </label>
            <label class="stack-control">
                Per page
                <select name="per">
                    <option value="25" {{if eq .Pagination.PerPage 25}}selected{{end}}>25</option>
                    <option value="50" {{if eq .Pagination.PerPage 50}}selected{{end}}>50</option>
                    <option value="100" {{if eq .Pagination.PerPage 100}}selected{{end}}>100</option>
                    <option value="200" {{if eq .Pagination.PerPage 200}}selected{{end}}>200</option>
                </select>
            </label>
            <button type="submit" class="btn btn-small">Apply</button>
        </form>
    </div>
    <div class="stack-tree">
        <div class="stack-tree-header">
            <div class="stack-cell stack-name">Stack</div>
            <div class="stack-cell scan-meta"><span class="sr-only">Last Scan</span></div>
            <div class="stack-cell status">Status</div>
        </div>
        <div class="stack-tree-body">
            {{range .Stacks}}
            <div class="stack-row stack-file" data-stack-path="{{.Path}}">
                <div class="stack-cell stack-name">
                    <a href="/projects/{{$.Name}}/stacks/{{.Path}}" class="stack-link">{{.Path}}</a>
                </div>
                <div class="stack-cell scan-meta">
                    <span class="meta-pill stack-scan-pill" data-last-scan="{{if not .RunAt.IsZero}}Last scan {{timeAgo .RunAt}}{{end}}">
                        {{if not .RunAt.IsZero}}Last scan {{timeAgo .RunAt}}{{else}}No scans yet{{end}}
                    </span>
                </div>
                <div class="stack-cell status">
                    {{if .Error}}<span class="badge badge-error">Error</span>
                    {{else if .Drifted}}<span class="badge badge-drift">Drifted</span>
                    {{else}}<span class="badge badge-ok">Healthy</span>{{end}}
                </div>
            </div>
            {{end}}
        </div>
    </div>
    <div class="stack-pagination">
        <div class="stack-pagination-meta">
            Showing {{len .Stacks}} of {{.Pagination.Total}} stacks
        </div>
        <div class="stack-pagination-actions">
            {{if .Pagination.PrevURL}}<a class="btn btn-small" href="{{.Pagination.PrevURL}}">Prev</a>{{end}}
            <span class="meta">Page {{.Pagination.Page}} / {{.Pagination.TotalPages}}</span>
            {{if .Pagination.NextURL}}<a class="btn btn-small" href="{{.Pagination.NextURL}}">Next</a>{{end}}
        </div>
    </div>
</section>
{{else if .Config}}
<p class="empty-state">No scans yet. Click "Scan All Stacks" to start.</p>
{{else}}
<p class="empty-state">Project not found in configuration.</p>
{{end}}

<script>
    (function () {
        if (!window.EventSource) return;
        const projectName = "{{.Name}}";
        const source = new EventSource(`/api/projects/${encodeURIComponent(projectName)}/events`);

        const formatStatus = (status, drifted, error) => {
            if (error) return '<span class="badge badge-error">Error</span>';
            if (status === "running") return '<span class="badge badge-running">Running</span>';
            if (drifted) return '<span class="badge badge-drift">Drifted</span>';
            return '<span class="badge badge-ok">Healthy</span>';
        };

        const updateRow = (stack) => {
            if (!stack || !stack.path) return;
            const row = document.querySelector(`.stack-row[data-stack-path="${CSS.escape(stack.path)}"]`);
            if (!row) return;
            const statusCell = row.querySelector(".stack-cell.status");
            if (statusCell) {
                statusCell.innerHTML = formatStatus(stack.status, stack.drifted, stack.error);
            }
            const scanPill = row.querySelector(".stack-scan-pill");
            if (scanPill) {
                if (stack.status === "running") {
                    scanPill.textContent = "Scanning...";
                } else {
                    const hasRunAt = Boolean(stack.run_at);
                    if (hasRunAt) {
                        scanPill.textContent = "Last scan just now";
                        scanPill.setAttribute("data-last-scan", "Last scan just now");
                    } else {
                        const lastScan = scanPill.getAttribute("data-last-scan");
                        scanPill.textContent = lastScan || "No scans yet";
                    }
                }
            }
        };

        const updateScanProgress = (scan) => {
            if (!scan) return;
            const summary = document.querySelector(".stack-progress-anchor.is-active");
            if (!summary) return;
            const progressFill = summary.querySelector(".progress-fill");
            const progressMeta = summary.querySelector(".progress .meta");
            if (!progressFill || !progressMeta) return;
            const done = (scan.completed || 0) + (scan.failed || 0);
            const total = scan.total || 0;
            progressFill.style.width = `${scan.progress_pct}%`;
            progressMeta.textContent = `${done} / ${total}`;
        };

        source.addEventListener("snapshot", (e) => {
            const data = JSON.parse(e.data || "{}");
            if (data.kind && data.kind !== "snapshot") return;
            if (Array.isArray(data.stacks)) {
                data.stacks.forEach((stack) => {
                    updateRow({
                        path: stack.path,
                        drifted: stack.drifted,
                        error: stack.error,
                        status: stack.error ? "failed" : (stack.drifted ? "completed" : "completed"),
                        run_at: stack.run_at,
                    });
                });
            }
            updateScanProgress(data.active_scan);
        });

        source.addEventListener("update", (e) => {
            const data = JSON.parse(e.data || "{}");
            const kind = data.kind || (data.type === "stack_update" ? "stack" : (data.type === "scan_update" ? "scan" : ""));
            if (kind === "stack") {
                updateRow({
                    path: data.stack_path,
                    drifted: data.drifted,
                    error: data.error,
                    status: data.status,
                    run_at: data.run_at,
                });
            }
            if (kind === "scan") {
                updateScanProgress({
                    completed: data.completed,
                    failed: data.failed,
                    total: data.total,
                    status: data.status,
                    progress_pct: data.progress_pct,
                });
                if (data.status === "completed" || data.status === "failed" || data.status === "canceled") {
                    window.location.reload();
                }
            }
        });

        window.addEventListener("pageshow", (event) => {
            if (event.persisted) {
                window.location.reload();
            }
        });
    })();
</script>

{{end}}
