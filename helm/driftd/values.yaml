image:
  repository: ghcr.io/driftdhq/driftd
  # Defaults to Chart.appVersion when empty.
  tag: ""
  # If set, digest takes precedence over tag (immutable deployment).
  digest: ""
  pullPolicy: IfNotPresent
  pullSecrets: []

service:
  type: ClusterIP
  port: 8080

metrics:
  enabled: true
  path: /metrics
  port: 8080

# Optional, user-supplied Kubernetes NetworkPolicy resources.
# Disabled by default.
networkPolicy:
  enabled: false
  policies: []
  # - name: server-ingress
  #   podSelector:
  #     matchLabels:
  #       app.kubernetes.io/name: driftd
  #       app.kubernetes.io/instance: driftd
  #       app.kubernetes.io/component: server
  #   policyTypes: ["Ingress"]
  #   ingress:
  #     - from:
  #         - namespaceSelector: {}
  #       ports:
  #         - protocol: TCP
  #           port: 8080

# Optional, user-supplied PodDisruptionBudget resources.
# Disabled by default.
podDisruptionBudget:
  enabled: false
  budgets: []
  # - name: server
  #   minAvailable: 1
  #   selector:
  #     matchLabels:
  #       app.kubernetes.io/name: driftd
  #       app.kubernetes.io/instance: driftd
  #       app.kubernetes.io/component: server

serviceAccount:
  create: true
  name: ""
  annotations: {}
  automountServiceAccountToken: true

server:
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  readinessProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: http
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 3
    failureThreshold: 3
  livenessProbe:
    enabled: true
    httpGet:
      path: /api/health
      port: http
    initialDelaySeconds: 20
    periodSeconds: 20
    timeoutSeconds: 3
    failureThreshold: 3
  nodeSelector: {}
  tolerations: []
  affinity: {}
  envFrom: []
  extraVolumes: []
  extraVolumeMounts: []
  extraEnv:
    - name: DRIFTD_DEFAULT_TERRAFORM_VERSION
      value: "1.14.4"
    - name: DRIFTD_DEFAULT_TERRAGRUNT_VERSION
      value: "0.99.1"
  # extraEnv:
  #   - name: LOG_LEVEL
  #     value: debug

worker:
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 2Gi
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    seccompProfile:
      type: RuntimeDefault
  securityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    capabilities:
      drop:
        - ALL
  livenessProbe:
    enabled: true
    exec:
      command:
        - /bin/sh
        - -c
        - "grep -aq driftd /proc/1/cmdline"
    initialDelaySeconds: 20
    periodSeconds: 30
    timeoutSeconds: 3
    failureThreshold: 3
  nodeSelector: {}
  tolerations: []
  affinity: {}
  envFrom: []
  extraVolumes: []
  extraVolumeMounts: []
  extraEnv:
    - name: DRIFTD_DEFAULT_TERRAFORM_VERSION
      value: "1.14.4"
    - name: DRIFTD_DEFAULT_TERRAGRUNT_VERSION
      value: "0.99.1"
  # extraEnv:
  #   # Direct value
  #   - name: TF_VAR_region
  #     value: us-east-1
  #   # From secret
  #   - name: CLOUDFLARE_API_TOKEN
  #     valueFrom:
  #       secretKeyRef:
  #         name: provider-credentials
  #         key: cloudflare-api-token
  #   # From configmap
  #   - name: TF_CLI_CONFIG_FILE
  #     valueFrom:
  #       configMapKeyRef:
  #         name: terraform-config
  #         key: terraformrc

storage:
  data:
    enabled: true
    existingClaim: ""
    size: 20Gi
    accessModes: ["ReadWriteMany"]
    storageClassName: ""
  cache:
    enabled: true
    existingClaim: ""
    size: 20Gi
    accessModes: ["ReadWriteMany"]
    storageClassName: ""

config:
  data_dir: /data
  listen_addr: ":8080"
  auth:
    mode: internal
    external:
      user_header: X-Auth-Request-User
      email_header: X-Auth-Request-Email
      groups_header: X-Auth-Request-Groups
      groups_delimiter: ","
      default_role: viewer
      roles:
        viewers: []
        operators: []
        admins: []
  ui_auth:
    username: ""
    password: ""
  api_auth:
    username: ""
    password: ""
    token: ""
    token_header: X-API-Token
    write_token: ""
    write_token_header: X-API-Write-Token
  redis:
    addr: "driftd-redis-master:6379"
    password: ""
    db: 0
  worker:
    concurrency: 5
    lock_ttl: 30m
    retry_once: true
    scan_max_age: 6h
    clone_depth: 1
    renew_every: 10s
    # Block stacks that declare Terraform data "external" in local stack files.
    # Helps reduce arbitrary command execution risk during `terraform plan`.
    block_external_data_source: false
  workspace:
    retention: 5
  projects: []

# Redis subchart configuration
redis:
  enabled: true
  architecture: standalone
  networkPolicy:
    enabled: false
  # Dev default only. Enable auth for any shared/prod cluster.
  auth:
    enabled: false
  image:
    registry: docker.io
    repository: bitnami/redis
    tag: latest
    digest: sha256:412da89feed59b1a45b0c1fd9d07cdb2e2283cf4db2e5a1604762ad03d53af6d  # Redis 8.4.0
  master:
    pdb:
      create: false
    persistence:
      # Dev default only. Enable persistence for production durability.
      enabled: false
  replica:
    pdb:
      create: false
